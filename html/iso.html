<html>

<head>

    <style>
        .cl_small_btn {
            font-family: Times;
            font-size: 10pt;
            color: black;
            background: #33d6ff;
            width: 100px;
        }
        
        .cl_small_text {
            font-family: Times;
            font-size: 10pt;
            color: black;
        }
        
        .cl_field_value {
            font-family: Courier New;
            font-size: 10pt;
            color: blue;
            width: 300px;
        }
        
        .cl_trace_value {
            font-family: Courier New;
            font-size: 8pt;
            color: black;
        }
        
        .cl_req_field_sel_cb {
            background: grey;
        }
        
        .cl_val_error {
            color: red;
            font-family: Times;
            font-size: 10pt;
        }
        
        .cl_text_label {
            color: #e26a21;
            font-family: Times;
            font-size: 10pt;
            font-weight: 100
        }

    </style>

    <script language="javascript">
        reqFieldsPrefixId0 = 'idJsRespFieldSelectedId_';
        reqFieldsPrefixId1 = 'idJsRespFieldId_';
        reqFieldsPrefixId2 = 'idJsRespFieldValueId_';
        reqFieldsValErrorIdPrefix = 'idJsFieldValErr_';

        respFieldsPrefixId0 = 'idJsRespFieldSelectedId_';
        respFieldsPrefixId1 = 'idJsRespFieldId_';
        respFieldsPrefixId2 = 'idJsRespFieldValueId_';

        function init() {
            jsLoadSpecs();
        }

        function jsLoadSpecs() {

            var onSuccessFuncCall = function(jsonData) {

                    var specsObj = JSON.parse(jsonData);
                    var htmlContent = '';
                    for (i = 0; i < specsObj.length; i++) {
                        specObj = specsObj[i];
                        htmlContent += "<option class=\"cl_small_text\" id=\"" + specObj.Id + "\">" + specObj.Name + "</option>";

                    }
                    elem = document.getElementById('idJsSpec');
                    elem.innerHTML = htmlContent;
                    jsLoadSpecMessages();

                } //end onSuccessFuncCall

            doAjaxCall('/iso/v0/specs', onSuccessFuncCall);


        } //end jsLoadSpecs

        function jsLoadSpecMessages(loadTemplate = false) {

            var specsElem = document.getElementById('idJsSpec');
            var selectedOption = specsElem.options[specsElem.selectedIndex];
            if (selectedOption) {
                var specId = selectedOption.id;

                var url = '/iso/v0/msgs/' + specId;
                var onSuccessFunc = function(jsonData) {
                        var msgsObj = JSON.parse(jsonData);
                        var htmlContent = '';
                        for (i = 0; i < msgsObj.length; i++) {
                            msgObj = msgsObj[i];
                            var selectedStatus = "";
                            if (i == 0) {
                                selectedStatus = "selected";
                            }
                            htmlContent += "<option class=\"cl_small_text\" id=\"" + msgObj.Id + "\"" +
                                selectedStatus + ">" + msgObj.Name + "</option>";

                        }
                        var elem = document.getElementById('idJsSpecMsgs');
                        elem.innerHTML = htmlContent;

                        if (loadTemplate) {
                            jsLoadTemplate();
                        }


                    } //end onSuccessFunc call

                doAjaxCall(url, onSuccessFunc)

            } else {
                console.log('please select a spec');
            }




        } //end jsLoadSpecMessages


        function jsLoadTemplate() {

            var specsElem = document.getElementById('idJsSpec');
            var selectedSpecOption = specsElem.options[specsElem.selectedIndex];
            if (selectedSpecOption) {
                var specId = selectedSpecOption.id;

                var msgsElem = document.getElementById('idJsSpecMsgs');
                var selectedMsgOption = msgsElem.options[msgsElem.selectedIndex];

                if (selectedMsgOption) {
                    var msgId = selectedMsgOption.id;

                    //now do the AJAX call
                    var url = '/iso/v0/template/' + specId + '/' + msgId;
                    var onSuccessFunc = function(jsonData) {


                        //alert(jsonData);
                        var obj = JSON.parse(jsonData);
                        var fieldsObj = obj.Fields;
                        currentMsgFields = fieldsObj;

                        var htmlContent = '';
                        htmlContent += "<tr class=\"cl_small_text\"><th > Selected? </th> <th> Field </th> <th> Value </th></tr>\n";
                        for (i = 0; i < fieldsObj.length; i++) {
                            var fieldObj = fieldsObj[i];
                            htmlContent += getFieldHtml(fieldObj, "", isRequest = true);
                            htmlContent += appendChildFields(fieldObj, isRequest = true);
                        }

                        var elem = document.getElementById('idJsRequestTable');
                        elem.innerHTML = htmlContent;
                    }

                    doAjaxCall(url, onSuccessFunc)
                } else {
                    console.log('please select a msg..');
                }


            } else {
                console.log('please select a spec and msg');
            }

        } //end jsLoadTemplate

        function getFieldHtml(fieldObj, fieldData = "", isRequest = true) {


            var fieldPosition = "";
            if (fieldObj.Position > 0) {
                fieldPosition = "[" + fieldObj.Position + "]";
            } else {
                fieldPosition = "[_]";
            }

            var id0 = reqFieldsPrefixId0;
            var id1 = reqFieldsPrefixId1;
            var id2 = reqFieldsPrefixId2;

            if (isRequest == false) {
                id0 = respFieldsPrefixId0;
                id1 = respFieldsPrefixId1;
                id2 = respFieldsPrefixId2;
            }

            var htmlContent = '<tr>';
            htmlContent += "<td class=\"cl_small_text\"> <input  class=\"cl_req_field_sel_cb\" id=\"" + id0 + fieldObj.Id + "\" type=\"checkbox\"/> " + fieldPosition + "</td>"
            htmlContent += "<td class=\"cl_small_text\" id=\"" + id1 + fieldObj.Id + "\">" + fieldObj.Name + "</td>";
            htmlContent += "<td>" + "<input id=\"" + id2 + fieldObj.Id + "\" class=\"cl_field_value\" type=\"text\" class=\"cl_small_text\" value=\"" + fieldData + "\"/>";
            if (isRequest) {
                htmlContent += "<div class=\"cl_val_error\" style=\"display:none;\" id=\"" + reqFieldsValErrorIdPrefix + fieldObj.Id + "\"> </div>"
            }

            htmlContent += "</td> </tr>";

            return htmlContent;


        }

        function appendChildFields(pFieldObj, isRequest = true) {

            var htmlContent = '';
            if (pFieldObj.Children.length > 0) {
                for (var i = 0; i < pFieldObj.Children.length; i++) {
                    var fieldObj = pFieldObj.Children[i];
                    htmlContent += getFieldHtml(fieldObj, "", isRequest);
                    htmlContent += appendChildFields(fieldObj, isRequest);
                }

            }
            return htmlContent;

        }

        function doAjaxCall(url, onSuccess, data, method = 'GET', contentType = null) {
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {


                    if (xhr.readyState == 4) {
                        if (xhr.status == 200) {
                            onSuccess(xhr.responseText);
                        } else {
                            console.log('failed. status code =' + xhr.status);
                        }
                    }
                } //end onreadystatechange
            xhr.open(method, url);
            if (contentType) {
                xhr.setRequestHeader('Content-Type', contentType);
            }

            console.log('making ajax request .. ' + url);
            xhr.send(data);
        } //end doAjaxCall()



        function jsShowTraceDialog() {

            var elem = document.getElementById('idJsTraceDiv');
            elem.style.display = "block";
            elem.style.position = "absolute";
            elem.style.left = "200px";
            elem.style.top = "300px";
            elem.style['z-index'] = "2";

        }

        function jsCancelTraceParseAction() {
            var elem = document.getElementById('idJsTraceDiv');
            elem.style.display = "none";

        }





        function jsParseTrace() {

            var specsElem = document.getElementById('idJsSpec');
            var selectedSpecOption = specsElem.options[specsElem.selectedIndex];
            if (selectedSpecOption) {
                var specId = selectedSpecOption.id;

                var msgsElem = document.getElementById('idJsSpecMsgs');
                var selectedMsgOption = msgsElem.options[msgsElem.selectedIndex];

                if (selectedMsgOption) {

                    var elem = document.getElementById('idJsTrace');
                    url = '/iso/v0/parse/' + specId + '/' + selectedMsgOption.id;
                    doAjaxCall(url, function(responseText) {

                        //alert(responseText);
                        var parsedMsgObj = JSON.parse(responseText);
                        //alert(parsedMsgObj.length)
                        for (var i = 0; i < parsedMsgObj.length; i++) {

                            var fieldDataObj = parsedMsgObj[i];
                            var elemId = reqFieldsPrefixId2 + fieldDataObj.Id;
                            //alert(elemId);
                            document.getElementById(elemId).value = fieldDataObj.Value;
                            document.getElementById(reqFieldsPrefixId0 + fieldDataObj.Id).checked = true;

                        }
                        jsCancelTraceParseAction();
                    }, elem.value, 'POST');



                }
            }



        }

        function newErrObj(fieldObj, errorText) {
            var errObj = new Object();
            errObj.Id = fieldObj.Id;
            errObj.FieldName = fieldObj.Name;
            errObj.ErrorText = errorText;
            return errObj;
        }

        function validateField(fieldObj, errors) {

            var elem = document.getElementById(reqFieldsPrefixId2 + fieldObj.Id);
            var valErroElem = document.getElementById(reqFieldsValErrorIdPrefix + fieldObj.Id);
            valErroElem.style.display = "none";
            valErroElem.innerHTML = "";

            if (fieldObj.Type == 'FIXED') {

                //console.log('validing fixed field ' + fieldObj.Name);

                var isSelected = document.getElementById(reqFieldsPrefixId0 + fieldObj.Id).checked;


                //console.log('selected ? ' + isSelected)
                if (isSelected) {

                    elem.style.color = 'blue';
                    var fieldVal = elem.value;
                    if (fieldVal) {

                        var len = fieldVal.length;
                        //console.log('field length = ' + len + ' expected length = ' + fieldObj.FixedSize);
                        if (fieldObj.DataEncoding == 'ASCII' || fieldObj.DataEncoding == 'EBCDIC') {

                            if (fieldVal.length != fieldObj.FixedSize) {
                                errors.push(newErrObj(fieldObj, 'field size mismatch - required: ' + fieldObj.FixedSize + ' found: ' + len));
                            }


                        } else if (fieldObj.DataEncoding == 'BCD' || fieldObj.DataEncoding == 'BINARY') {
                            var len = fieldVal.length / 2;
                            if (len != fieldObj.FixedSize) {
                                errors.push(newErrObj(fieldObj, 'field size mismatch - required: ' + fieldObj.FixedSize + ' found: ' + len));

                            }

                        }

                    } else {
                        errors.push(newErrObj(fieldObj, 'field selected but no value provided.'));
                    }
                }

            }



            if (fieldObj.Children.length > 0) {

                for (var i = 0; i < fieldObj.Children.length; i++) {
                    console.log('validating ' + fieldObj.Children[i].Name + ' Id = ' + fieldObj.Children[i].Id + ' field type = ' + fieldObj.Children[i].Type);
                    validateField(fieldObj.Children[i], errors);


                }

            }

        }

        function validateFields() {

            var errors = new Array();
            for (var i = 0, j = 0; i < currentMsgFields.length; i++) {
                var fieldObj = currentMsgFields[i];
                validateField(fieldObj, errors);

            }

            var errMsg = 'Please fix the following errors -\n<ol>';
            for (var i = 0; i < errors.length; i++) {
                var errObj = errors[i];
                var elem = document.getElementById(reqFieldsPrefixId2 + errObj.Id);
                elem.style.color = 'red';


                var errorTextElem = document.getElementById(reqFieldsValErrorIdPrefix + errObj.Id);
                errorTextElem.innerHTML = errObj.ErrorText;
                errorTextElem.style.display = "block";
                errMsg += '<li>' + 'Field: [' + errObj.FieldName + '] Error:  ' + errObj.ErrorText + '</li>\n';

            }
            errMsg += '</ol>';
            if (errors.length > 0) {
                showErrorMessage(errMsg);
            }


            return errors;

        }


        /**
        This function will send a msg to the 'Host:Ip'
        */
        function jsSendMsg() {

            var validationErrors = validateFields();
            if (validationErrors.length > 0) {
                return;

            }

            var selectedObjs = document.getElementsByClassName('cl_req_field_sel_cb');
            var resultObj = new Array();
            for (var i = 0, j = 0; i < selectedObjs.length; i++) {

                var childNode = selectedObjs[i];
                //alert(JSON.stringify(childNode));
                if (childNode.id) {
                    //alert(childNode.id)

                    if (childNode.checked) {
                        var index = childNode.id.indexOf('_');
                        var childNodeId = childNode.id.substring(index + 1, childNode.id.length);

                        var fieldValue = document.getElementById(reqFieldsPrefixId2 + childNodeId).value;
                        var obj = new Object();
                        obj.Id = parseInt(childNodeId);
                        obj.Value = fieldValue;
                        resultObj[j++] = obj;
                    }

                }


            }
            var msg = JSON.stringify(resultObj);
            var specsElem = document.getElementById('idJsSpec');
            var selectedOption = specsElem.options[specsElem.selectedIndex];
            var specId = selectedOption.id;
            selectedOption = document.getElementById('idJsSpecMsgs');
            var msgId = selectedOption.options[selectedOption.selectedIndex].id;

            console.log('spec id = ' + specId + ' msg id = ' + msgId);
            var postData = 'specId=' + specId + "&" + 'msgId=' + msgId + "&" + "msg=" + msg;
            console.log('postData = ' + postData);
            doAjaxCall('/iso/v0/send', function(responseText) {
                alert(responseText);
                var responseData = JSON.parse(responseText);

                var htmlContent = '';
                htmlContent += "<tr class=\"cl_small_text\"><th > Selected? </th> <th> Field </th> <th> Value </th></tr>\n";
                for (var i = 0; i < currentMsgFields.length; i++) {
                    var fieldObj = currentMsgFields[i];
                    htmlContent += getFieldHtml(fieldObj, fieldValue = "", isRequest = false);
                    htmlContent += appendChildFields(fieldObj, isRequest = false);
                }

                alert(htmlContent);

                var elem = document.getElementById('idJsResponseTable');
                elem.innerHTML = htmlContent;

                for (var i = 0; i < responseData.length; i++) {

                    var id = respFieldsPrefixId0 + responseData[i].Id;
                    var fieldId = respFieldsPrefixId2 + responseData[i].Id;
                    document.getElementById(id).checked = true;
                    document.getElementById(fieldId).value = responseData[i].Value;






                }


            }, postData, 'POST', encoding = 'application/x-www-form-urlencoded');




        }

        function showErrorMessage(errMsg) {

            //alert(errMsg);
            document.getElementById('idJsErrorMsg').innerHTML = errMsg;

            var elem = document.getElementById('idJsErrorDiv');
            elem.style.display = "block";
            elem.style.position = "absolute";
            elem.style.left = "200px";
            elem.style.top = "300px";
            elem.style['z-index'] = "2";

        }

        function closeErrorDialog() {
            document.getElementById('idJsErrorDiv').style.display = "none";
        }

    </script>

</head>

<body onload="init()">

    <h2 style="font-family: 'Comic Sans MS'"> ISO WebSim</h2>
    <div class="cl_small_text">Developer(s): Raghavendra Balgi (raghavendra.a.balgi@aexp.com) </div>
    <hr>

    <table style="position: relative; z-index: 1;">
        <tr>
            <td>
                <div class="cl_text_label">Specs</div>
                <!--<input class="cl_small_btn" type="button" value="Load Specs" onClick="jsLoadSpecs()" /> -->
            </td>

            <td>
                <select onchange="jsLoadSpecMessages(true)" id="idJsSpec" name="jsSpec" style="width: 200px;">
                </select>
            </td>

        </tr>


        <! -- second row -->

        <tr>
            <td>
                <!--<input class="cl_small_btn" type="button" value="Load Messages" onClick="jsLoadSpecMessages()" />-->
                <div class="cl_text_label">Spec Messages</div>
            </td>

            <td>
                <select onchange="jsLoadTemplate()" id="idJsSpecMsgs" name="jsSpecMsgs" style="width: 200px;"></select>
            </td>

        </tr>

        <tr>
            <table>

                <tr>

                    <td>
                        <div class="cl_text_label">Host</div>
                    </td>
                    <td>
                        <input type="text" value="127.0.0.1" />
                    </td>
                    <td>
                        <div class="cl_text_label">Port</div>
                    </td>
                    <td>
                        <input type="text" value="6767" />
                    </td>

                </tr>
                <tr>

                    <td>
                        <div class="cl_text_label">MLI</div>
                    </td>
                    <td>
                        <select class="cl_small_text" id="idJsMli">
                            <option name="2I">2I</option>
                            <option name="2E">2E</option>
                        </select>
                    </td>


                    <td></td>
                </tr>


            </table>

        </tr>



    </table>

    <br/>
    <br/>
    <div style="position:relative; z-index: 1;">
        <input class="cl_small_btn" type="button" value="Load Template" onClick="jsLoadTemplate()" />
        <input class="cl_small_btn" type="button" value="Parse Trace" onClick="jsShowTraceDialog()" />
        <input class="cl_small_btn" type="button" value="Validate" onClick="validateFields()" />
        <input class="cl_small_btn" type="button" value="Send To Host" onClick="jsSendMsg()" />
    </div>

    <br/>
    <br/>
    <table>
        <tr>
            <td>
                <!-- Request Table -->
                <table id="idJsRequestTable">

                </table>
            </td>

            <td>
                <!-- Request Table -->
                <table id="idJsResponseTable">

                </table>
            </td>
        </tr>
    </table>

    <div id="idJsTraceDiv" style="margin-left: 10px; margin-right: 10px; width:450px; height: 230px;display: none; background: #ccff99;">

        <div class="cl_small_text" style="width: 450px;height: 30px;background-color:#ff8080;">Hex Trace Input Dialog</div>
        <textarea class="cl_trace_value" id="idJsTrace" rows="5" cols="40" style=" resize: none; margin: 5px; margin:5px; width: 440px; height:140px;">F1F1F0F0723C240128428000F1F5F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9F0F0F4F0F0F0F0F0F0F0F0F0F0F0F1F0F0F0F0F4F2F1F1F0F2F4F5F1F1F1F0F6F0F2F0F5F1F0F1F8F1F9F4F3F1F2F0F5F0F3F0F9F0F1F8F4F0F2F6F1F1F0F1F1F0F1F1F4F0F0F1F0F3F7F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9C4F0F8F0F8F1F0F1F0F4F0F1F3F6F6F7F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F1F5F4F3F4F5F0F1F3F6F74040404040F2F4F9C1E7C9C1C3F2F1F0F9F0F1F0F1C1D7D5F2F3C6D9D6E2E340D1C1D5C540D440D4D9E240404040404040C1C2C34040E7E8E94040D9E3C7F6F1F1F0C1C2C3404061C4C5C6404061C7C8C9404061D1D2D3404061D4D5D6404061D7D8D9404061E2E3E4404061E5E6E7404061E8E9C1404061E7E8E94040C1D3C3F5F5F0F9C1C240404061E7E840404061C2C340404061C3C440404061C4C540404061C4C54040406140C3C440404061C2C340404061C1C2404040C1C2C3F1F2F3C4C5C6F4F5F6C7C8C9F7F8F9D1D2D3F0F1F2F0F0F1F1F2F74BF1F4F24BF1F5F14BF2F2F3C3C540F2F4C3C6C6D9D6E2E37CC5D4C1C9D3C1C4C4D9C5E2E24BC3D6D4F8F4F0</textarea>


        <br/>
        <br/>
        <div align="center" style="align-content:center;">
            <input type="button" class="cl_small_btn" value="OK " onclick="jsParseTrace()" />
            <input type="button" class="cl_small_btn" value="Cancel " onclick="jsCancelTraceParseAction()" />
        </div>
    </div>

    <div id="idJsErrorDiv" style="z-index:9999;margin-left: 10px; margin-right: 10px; width:450px; height: 250px;display: none; background: #ccff99;">

        <div class="cl_small_text" style="width: 450px;height: 30px;background-color:#ff8080;">WebSim Error Message</div>
        <div id="idJsErrorMsg" class="cl_small_text" style="overflow:auto; margin: 5px; margin:5px; width: 440px; height:140px; color: red"></div>

        <br/>
        <br/>
        <div align="center" style="align-content:center;">
            <input type="button" class="cl_small_btn" value="OK " onclick="closeErrorDialog()" />

        </div>
    </div>




</body>

</html>
