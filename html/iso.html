<html>

<head>

    <link href="https://fonts.googleapis.com/css?family=Cormorant+Garamond|Gloria+Hallelujah|Lora" rel="stylesheet">

    <style>
        #overlay {
            //display: none;
            position: absolute;
            z-index: 80;
            opacity: 0.8;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%
        }
        
        #navDiv {
            position: relative;
            //top: 0px;
            left: 0px;
            width: 10%;
            height: 100%;
            float: left;
            //border-style: groove;
            //border-color: blue;
            padding: 2px;
            margin: 0px;
            z-index: 90;
        }
        
        #headerDiv {
            position: relative;
            top: 0px;
            left: 0px;
            height: 15%;
            width: 100%;
            float: left;
            //border-style: dashed;
            //border-color: red;
            z-index: 90;
        }
        
        #bodyDiv {
            position: relative;
            //top: 200px;
            //left: 30px;
            //height: 80px;
            width: 85%;
            float: left;
            //border-style: double;
            overflow: hidden;
            z-index: 90;
        }
        
        .cl_cursive_heading {
            font-family: "Gloria Hallelujah", serif;
            font-size: 35px;
        }
        
        .cl_small_text_new {
            font-family: 'Lora', serif;
            font-size: 14px;
        }
        
        .cl_small_btn {
            font-family: 'Lora', serif;
            font-size: 10pt;
            color: black;
            background: #33d6ff;
            width: 120px;
        }
        
        .cl_vsmall_btn_edit {
            font-family: Lora;
            font-size: 10pt;
            color: black;
            background: #bfbb53;
            width: 50px;
        }
        
        .cl_vsmall_btn_view {
            font-family: 'Lora', serif;
            font-size: 10pt;
            color: black;
            background: #bfbb53;
            width: 50px;
        }
        
        .cl_small_text {
            font-family: Lora, serif;
            font-size: 10pt;
            color: black;
        }
        
        .cl_field_name {
            font-family: 'Cormorant Garamond', 'Lora', serif;
            font-size: 18px;
            color: #25235a;
        }
        
        .cl_table_heading {
            font-family: 'Cormorant Garamond', 'Lora', serif;
            font-size: 19px;
            color: #221441;
        }
        
        .cl_segment_header_req {
            font-family: Lora, serif;
            font-size: 12pt;
            font-weight: 200;
            background: #ccff99;
        }
        
        .cl_segment_header_resp {
            font-family: Lora, serif;
            font-size: 11pt;
            font-weight: 200;
            background: #cacadd;
        }
        
        .cl_field_value {
            font-family: 'Courier New', monospace;
            font-size: 11pt;
            color: #090933;
            width: 150px;
        }
        
        .cl_field_pos {
            font-family: Lora, serif;
            font-size: 11pt;
            color: #e64a0a;
        }
        
        .cl_trace_value {
            font-family: 'Courier New', monospace;
            font-size: 10pt;
            color: black;
        }
        
        .cl_req_field_sel_cb {
            background: grey;
        }
        
        .cl_val_error {
            color: red;
            font-family: Lora, serif;
            font-size: 9pt;
        }
        
        .cl_text_label {
            color: black;
            font-family: Lora, serif;
            font-size: 11pt;
            height: 25px;
            width: 150px;
            //align-content: center;
            background: #bbcad1;
        }
        
        .cl_std_text_box {
            background-color: #ededdd;
            border: 1px solid #848484;
            height: 25px;
            width: 200px;
            outline: 0;
            font-family: Lora, serif;
            font-size: 11pt;
        }
        
        .cl_std_cbox {
            background-color: #ededdd;
            border: 1px solid #848484;
            height: 25px;
            width: 200px;
            outline: 0;
            font-family: Lora, serif;
            font-size: 11pt;
            z-index: 90;
        }
        
        .cl_trace_dlg {
            margin-left: 10px;
            margin-right: 10px;
            width: 455px;
            height: 230px;
            display: none;
            background: white;
            border-style: solid;
            border-width: 1px;
            border-color: blue;
            z-index: 100;
            //opacity: 1;
            position: absolute;
        }
        
        .cl_about_dlg {
            margin-left: 10px;
            margin-right: 10px;
            width: 455px;
            height: 300px;
            display: none;
            background: white;
            border-style: solid;
            border-width: 1px;
            border-color: blue;
            z-index: 100;
            //opacity: 1;
            position: absolute;
        }
        
        .cl_cb_opt {
            font-family: SourceCodePro-Medium;
            font-size: 11pt;
        }
        
        .cl_dlg_header {
            font-family: Lora, serif;
            width: 455px;
            background: gainsboro;
        }

    </style>

    <script language="javascript">
        //globals

        var alphaRE = /^[a-zA-Z]+$/;
        var alphaNumericRE = /^[0-9a-zA-Z]+$/;
        var numericRE = /^[0-9]+$/;

        var reqFieldsPrefixId0 = 'idJsReqFieldSelectedId_';
        var reqFieldsPrefixId1 = 'idJsReqFieldId_';
        var reqFieldsPrefixId2 = 'idJsReqFieldValueId_';
        var reqFieldsValErrorIdPrefix = 'idJsFieldValErr_';

        var respFieldsPrefixId0 = 'idJsRespFieldSelectedId_';
        var respFieldsPrefixId1 = 'idJsRespFieldId_';
        var respFieldsPrefixId2 = 'idJsRespFieldValueId_';

        gFieldEdited = {
            fieldId: "",
            fieldSegment: 'request'
        };

        function init() {

            //console.log(window.chrome + '' + window.chrome.webstore)
            if (window.chrome && window.chrome.webstore) {
                jsLoadSpecs();

            } else {
                alert('This application has been tested only on chrome browser.');
            }


        }

        function jsLoadSpecs() {

            var onSuccessFuncCall = function(jsonData) {

                    var specsObj = JSON.parse(jsonData);
                    var htmlContent = '';
                    for (i = 0; i < specsObj.length; i++) {
                        specObj = specsObj[i];
                        htmlContent += "<option class=\"cl_cb_opt\" id=\"" + specObj.Id + "\">" + specObj.Name + "</option>";

                    }
                    elem = document.getElementById('idJsSpec');
                    elem.innerHTML = htmlContent;
                    jsLoadSpecMessages();

                } //end onSuccessFuncCall

            doAjaxCall('/iso/v0/specs', onSuccessFuncCall);


        } //end jsLoadSpecs

        function jsLoadSpecMessages(loadTemplate = false) {

            document.getElementById('idJsResponseTable').innerHTML = '';

            var specsElem = document.getElementById('idJsSpec');
            var selectedOption = specsElem.options[specsElem.selectedIndex];
            if (selectedOption) {
                var specId = selectedOption.id;

                var url = '/iso/v0/msgs/' + specId;
                var onSuccessFunc = function(jsonData) {
                        var msgsObj = JSON.parse(jsonData);
                        var htmlContent = '';
                        for (i = 0; i < msgsObj.length; i++) {
                            msgObj = msgsObj[i];
                            var selectedStatus = "";
                            if (i == 0) {
                                selectedStatus = "selected";
                            }
                            htmlContent += "<option class=\"cl_small_text\" id=\"" + msgObj.Id + "\"" +
                                selectedStatus + ">" + msgObj.Name + "</option>";

                        }
                        var elem = document.getElementById('idJsSpecMsgs');
                        elem.innerHTML = htmlContent;

                        if (loadTemplate) {
                            jsLoadTemplate();
                        }


                    } //end onSuccessFunc call

                doAjaxCall(url, onSuccessFunc)

            } else {
                console.log('please select a spec');
            }




        } //end jsLoadSpecMessages


        function jsLoadTemplate() {

            var specsElem = document.getElementById('idJsSpec');
            var selectedSpecOption = specsElem.options[specsElem.selectedIndex];
            if (selectedSpecOption) {
                var specId = selectedSpecOption.id;

                var msgsElem = document.getElementById('idJsSpecMsgs');
                var selectedMsgOption = msgsElem.options[msgsElem.selectedIndex];

                if (selectedMsgOption) {
                    var msgId = selectedMsgOption.id;

                    //now do the AJAX call
                    var url = '/iso/v0/template/' + specId + '/' + msgId;
                    var onSuccessFunc = function(jsonData) {


                        //alert(jsonData);
                        var obj = JSON.parse(jsonData);
                        var fieldsObj = obj.Fields;
                        currentMsgFields = fieldsObj;

                        var htmlContent = '';
                        htmlContent += '<tr><td colspan=\"4\" align="center"><div class="cl_segment_header_req">Message Request</div></td><tr>';
                        htmlContent += "<tr class=\"cl_table_heading\"><th > Selected? </th> <th> Field </th> <th> Value </th></tr>\n";
                        for (i = 0; i < fieldsObj.length; i++) {
                            var fieldObj = fieldsObj[i];
                            htmlContent += getFieldHtml(fieldObj, "", isRequest = true);
                            htmlContent += appendChildFields(fieldObj, isRequest = true);
                        }

                        var elem = document.getElementById('idJsRequestTable');
                        elem.innerHTML = htmlContent;

                        var elems = document.getElementsByClassName('cl_vsmall_btn_edit');
                        for (var i = 0; i < elems.length; i++) {
                            elems[i].addEventListener('click', function(event) {

                                var fieldVal = "";
                                var index = event.target.id.indexOf('_');
                                var fieldId = event.target.id.substring(index + 1, event.target.id.length);
                                console.log('fieldid =' + fieldId);
                                fieldVal = getRequestFieldValElem(fieldId).value;


                                jsShowUserInputDialog(event, fieldId, fieldVal, true, false);
                            }, true);
                        }



                    }

                    doAjaxCall(url, onSuccessFunc)
                } else {
                    console.log('please select a msg..');
                }


            } else {
                console.log('please select a spec and msg');
            }

        } //end jsLoadTemplate

        function getFieldHtml(fieldObj, fieldData = "", isRequest = true) {



            var fieldPosition = "";
            if (fieldObj.Position > 0) {
                fieldPosition = "[" + fieldObj.Position + "]";
            } else {
                fieldPosition = "[!]";
            }



            //console.log('isreq ' + isRequest);
            var id0 = reqFieldsPrefixId0;
            var id1 = reqFieldsPrefixId1;
            var id2 = reqFieldsPrefixId2;

            if (isRequest == false) {
                console.log('madness');
                id0 = respFieldsPrefixId0;
                id1 = respFieldsPrefixId1;
                id2 = respFieldsPrefixId2;
            }
            //console.log(id0 + id1 + id2)

            var htmlContent = '<tr>';

            var disabledFlag = "";
            if (isRequest == false) {
                disabledFlag = "disabled";

            }

            htmlContent += "<td class=\"cl_field_pos\"> <input class=\"cl_req_field_sel_cb\" id=\"" + id0 + fieldObj.Id + "\" type=\"checkbox\"" + disabledFlag + "/>" + fieldPosition + "</td>"
            htmlContent += "<td class=\"cl_field_name\" id=\"" + id1 + fieldObj.Id + "\">" + fieldObj.Name + "</td>";



            if (isRequest) {
                htmlContent += "<td>" + "<input id=\"" + id2 + fieldObj.Id + "\" class=\"cl_field_value\" type=\"text\" class=\"cl_small_text\" value=\"" + fieldData + "\"/>";
                htmlContent += "<div class=\"cl_val_error\" style=\"display:none;\" id=\"" + reqFieldsValErrorIdPrefix + fieldObj.Id + "\"> </div></td>";
                htmlContent += '<td><input class="cl_vsmall_btn_edit" type="button" value="Edit" id="idReqFieldEdit_' + fieldObj.Id + '\")/> </td>';

            } else {
                htmlContent += "<td>" + "<input id=\"" + id2 + fieldObj.Id + "\" class=\"cl_field_value\" type=\"text\" class=\"cl_small_text\" value=\"" + fieldData + "\" disabled/>";
                htmlContent += '</td>'
                htmlContent += '<td><input class="cl_vsmall_btn_view" type="button" value="View" id="idRespFieldView_' + fieldObj.Id + '\"/> </td>';
            }

            htmlContent += "</tr>";

            return htmlContent;


        }

        function appendChildFields(pFieldObj, isRequest = true) {

            var htmlContent = '';
            if (pFieldObj.Children.length > 0) {
                for (var i = 0; i < pFieldObj.Children.length; i++) {
                    var fieldObj = pFieldObj.Children[i];
                    htmlContent += getFieldHtml(fieldObj, "", isRequest);
                    htmlContent += appendChildFields(fieldObj, isRequest);
                }

            }
            return htmlContent;

        }

        function doAjaxCall(url, onSuccess, data, method = 'GET', contentType = null) {
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {


                    if (xhr.readyState == 4) {
                        if (xhr.status == 200) {
                            onSuccess(xhr.responseText);
                        } else {
                            console.log('failed. status code =' + xhr.status);
                            showErrorMessage('Request Failed. ' + 'Http Status: ' + xhr.status + ' Message = ' + xhr.responseText);
                        }
                    }
                } //end onreadystatechange
            xhr.open(method, url);
            if (contentType) {
                xhr.setRequestHeader('Content-Type', contentType);
            }

            console.log('making ajax request .. ' + url);
            xhr.send(data);
        } //end doAjaxCall()



        function enableOverlay() {
            document.getElementById('overlay').style['z-index'] = 99;
        }

        function disableOverlay() {
            document.getElementById('overlay').style['z-index'] = 80;
        }

        function jsShowTraceDialog() {

            enableOverlay();
            var elem = document.getElementById('idJsTraceDiv');
            elem.style.display = "block";
            elem.style.position = "fixed";
            elem.style.left = "35%";
            elem.style.top = "50%";



            //elem.style['z-index'] = "2";

        }

        function jsCancelTraceParseAction() {
            disableOverlay();
            var elem = document.getElementById('idJsTraceDiv');
            elem.style.display = "none";


        }

        function getRequestFieldValElem(fieldId) {
            return document.getElementById(reqFieldsPrefixId2 + fieldId);
        }

        function getResponseFieldValElem(fieldId) {
            return document.getElementById(respFieldsPrefixId2 + fieldId);
        }

        //functions related to dealing with user input - 


        function editRequestField(fieldId) {

            var fieldElem = getRequestFieldValElem(fieldId);
            var initialValue = fieldElem.value;
            jsShowUserInputDialog();

        }

        function jsShowUserInputDialog(e, fieldId, initialValue, isrequest = true, readonly = false) {

            enableOverlay();
            var x = e.clientX;
            var y = e.pageY - e.screenY;
            if (fieldId) {
                //var elem = getRequestFieldValElem(fieldId);
                var divElem = document.getElementById('idJsUserInputDiv');
                var textAreaElem = document.getElementById('idJsUserInput');

                //global vars to indicate what was being edited
                if (isrequest) {
                    gFieldEdited.fieldId = fieldId;
                    gFieldEdited.fieldSegment = 'res';
                }
                //done global
                textAreaElem.value = initialValue;
                if (!readonly) {
                    textAreaElem.disabled = false;
                } else {
                    textAreaElem.disabled = true;
                }

                x = 10;
                //console.log('screenY = ' + e.pageY);
                y = e.pageY - 500;
                //show the div
                divElem.style.display = "block";
                //divElem.style.left = x;
                //divElem.style.top = y;
                //console.log("right = " + divElem.style.right);
                if (isrequest == false) {
                    divElem.style.right = '0%';
                } else {
                    divElem.style.right = '';
                }
                divElem.style.bottom = '0%';
                divElem.style.position = "fixed";

            }

        }

        function getFieldValElem(fieldId, segment) {

            var elemId = "";
            if (segment == 'request') {
                elemId = reqFieldsPrefixId2 + fieldId;
            } else {
                elemId = respFieldsPrefixId2 + fieldId;
            }

            return document.getElementById(elemId);

        }

        function getFieldSelectedElem(fieldId, segment) {

            var elemId = "";
            if (segment == 'request') {
                elemId = reqFieldsPrefixId0 + fieldId;
            } else {
                elemId = respFieldsPrefixId0 + fieldId;
            }

            return document.getElementById(elemId);

        }

        function jsProcessUserInput() {

            //enableOverlay();
            var elem = document.getElementById('idJsUserInputDiv');

            var textAreaElem = document.getElementById('idJsUserInput');

            if (textAreaElem.disabled) {
                //response field being viewed, do nothing
                textAreaElem.value = "";
                textAreaElem.disabled = false;
                elem.style.display = "none";
                disableOverlay();
                return;

            }

            var fieldId = gFieldEdited.fieldId;
            console.log('field being edited -' + fieldId);
            var fieldValElem = getFieldValElem(fieldId, 'request');
            var fieldSelectedElem = getFieldSelectedElem(fieldId, 'request');
            fieldValElem.value = textAreaElem.value;
            if (fieldValElem.value) {
                fieldSelectedElem.checked = true;
            } else {
                fieldSelectedElem.checked = false;
            }
            textAreaElem.value = "";
            elem.style.display = "none";
            disableOverlay();
        }


        function jsCancelUserInputDialog() {
            var elem = document.getElementById('idJsUserInputDiv');
            elem.style.display = "none";
            disableOverlay();

        }



        function jsParseTrace() {


            var specsElem = document.getElementById('idJsSpec');
            var selectedSpecOption = specsElem.options[specsElem.selectedIndex];
            if (selectedSpecOption) {
                var specId = selectedSpecOption.id;

                var msgsElem = document.getElementById('idJsSpecMsgs');
                var selectedMsgOption = msgsElem.options[msgsElem.selectedIndex];

                if (selectedMsgOption) {

                    var elem = document.getElementById('idJsTrace');
                    url = '/iso/v0/parse/' + specId + '/' + selectedMsgOption.id;
                    doAjaxCall(url, function(responseText) {

                        console.log('parsed msg (json)' + responseText);
                        var parsedMsgObj = JSON.parse(responseText);
                        //alert(parsedMsgObj.length)
                        for (var i = 0; i < parsedMsgObj.length; i++) {

                            var fieldDataObj = parsedMsgObj[i];
                            var elemId = reqFieldsPrefixId2 + fieldDataObj.Id;
                            //alert(elemId);
                            document.getElementById(elemId).value = fieldDataObj.Value;
                            document.getElementById(reqFieldsPrefixId0 + fieldDataObj.Id).checked = true;

                        }
                        jsCancelTraceParseAction();
                    }, elem.value, 'POST');



                }
            }



        }

        function newErrObj(fieldObj, errorText) {
            var errObj = new Object();
            errObj.Id = fieldObj.Id;
            errObj.FieldName = fieldObj.Name;
            errObj.ErrorText = errorText;
            return errObj;
        }

        function validateField(fieldObj, errors) {



            var elem = document.getElementById(reqFieldsPrefixId2 + fieldObj.Id);
            var valErroElem = document.getElementById(reqFieldsValErrorIdPrefix + fieldObj.Id);
            valErroElem.style.display = "none";
            valErroElem.innerHTML = "";

            elem.style.color = '#090933';
            var fieldVal = elem.value;
            var isSelected = document.getElementById(reqFieldsPrefixId0 + fieldObj.Id).checked;


            //console.log('validating ' + fieldObj.Name + ' Id = ' + fieldObj.Id + ' field type = ' + fieldObj.Type + ' fieldVal = ' + fieldVal + ' is selected = ' + isSelected);
            if (isSelected) {


                if (fieldObj.Type == 'VARIABLE') {
                    validateVariableField(fieldObj, fieldVal, errors);

                } else if (fieldObj.Type == 'FIXED') {
                    validateFixedField(fieldObj, fieldVal, errors);
                }
            }


            if (fieldObj.Children.length > 0) {

                for (var i = 0; i < fieldObj.Children.length; i++) {
                    validateField(fieldObj.Children[i], errors);
                }

            }

        }


        function validateFixedField(fieldObj, fieldVal, errors) {

            if (!fieldVal) {
                errors.push(newErrObj(fieldObj, 'Field selected but no value provided.'));
                return;

            }

            console.log('vali = ' + fieldObj.Name);

            switch (fieldObj.DataEncoding) {

                case 'ASCII':
                case 'EBCDIC':
                    {

                        if (fieldVal.length != fieldObj.FixedSize) {
                            errors.push(newErrObj(fieldObj, 'Field length mismatch. Required = ' + fieldObj.FixedSize + ' Found = ' + fieldVal.length));
                        }

                        validateFieldContentConstraints(fieldObj, fieldVal, errors);


                        break;
                    }
                case 'BINARY':
                    {
                        if (!validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors)) {
                            var len = fieldVal.length / 2;
                            if (len != fieldObj.FixedSize) {
                                errors.push(newErrObj(fieldObj, 'Field length mismatch. Required = ' + fieldObj.FixedSize + ' Found = ' + len));
                            }
                        }
                        //validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors);
                        validateBinaryFieldForContent(fieldObj, fieldVal, errors);
                        break;
                    }
                case 'BCD':
                    {
                        if (!validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors)) {
                            var len = fieldVal.length / 2;
                            if (len != fieldObj.FixedSize) {
                                errors.push(newErrObj(fieldObj, 'Field length mismatch. Required = ' + fieldObj.FixedSize + ' Found = ' + len));
                            }
                        }
                        validateBcdFieldForContent(fieldObj, fieldVal, errors);
                        break;
                    }

            }


        }



        function validateVariableField(fieldObj, fieldVal, errors) {

            if (!fieldVal) {
                errors.push(newErrObj(fieldObj, 'Field selected but no value provided.'));
                return;

            }

            switch (fieldObj.DataEncoding) {

                case 'ASCII':
                case 'EBCDIC':
                    {
                        validateFieldContentConstraints(fieldObj, fieldVal, errors);
                        validateVariableFieldLengthConstraints(fieldObj, fieldVal, errors);

                        break;
                    }
                case 'BINARY':
                    {
                        validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors);
                        validateBinaryFieldForContent(fieldObj, fieldVal, errors);
                        validateVariableFieldLengthConstraints(fieldObj, fieldVal, errors);
                        break;
                    }
                case 'BCD':
                    {
                        validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors);
                        validateBcdFieldForContent(fieldObj, fieldVal, errors);
                        validateVariableFieldLengthConstraints(fieldObj, fieldVal, errors);
                    }

            }


        }

        function validateVariableFieldLengthConstraints(fieldObj, fieldVal, errors) {


            if (fieldObj.Type == 'VARIABLE') {

                var fieldLen = 0;
                if (fieldObj.DataEncoding == 'ASCII' || fieldObj.DataEncoding == 'EBCDIC') {
                    fieldLen = fieldVal.length;
                } else {
                    fieldLen = fieldVal.length / 2;
                }

                //console.log('field length: ' + fieldLen);
                //console.log('field min: ' + fieldObj.MinSize);
                // console.log('field max: ' + fieldObj.MaxSize);


                if (fieldObj.MinSize > 0 && fieldLen < fieldObj.MinSize) {
                    errors.push(newErrObj(fieldObj, 'Field length less than minimum allowed length of ' + fieldObj.MinSize));
                }

                if (fieldObj.MaxSize > 0 && fieldLen > fieldObj.MaxSize) {
                    errors.push(newErrObj(fieldObj, 'Field length exceeds maximum allowed length of ' + fieldObj.MaxSize));
                }

            }

        }

        function validateFieldContentConstraints(fieldObj, fieldVal, errors) {



            switch (fieldObj.ContentType) {
                case 'Alpha':
                    {

                        if (!alphaRE.exec(fieldVal)) {
                            errors.push(newErrObj(fieldObj, 'Field content should be alphabets only.'));
                            return true;

                        }
                        break;

                    }
                case 'AlphaNumeric':
                    {

                        if (!alphaRE.exec(fieldVal)) {
                            errors.push(newErrObj(fieldObj, 'Field content should be alpha-numeric only.'));
                            return true;

                        }
                        break;

                    }
                case 'Numeric':
                    {

                        if (!numericRE.exec(fieldVal)) {
                            errors.push(newErrObj(fieldObj, 'Field content should be numeric only.'));
                            return true;

                        }
                        break;
                    }
            }



        }


        function validateBinaryFieldForContent(fieldObj, fieldVal, errors) {
            var re = /^[0123456789abcdefABCDEF]+$/;
            if (!re.exec(fieldVal)) {
                errors.push(newErrObj(fieldObj, 'BINARY fields should contain hex characters only.'));
                return true;
            }
            return false;

        }

        function validateBcdFieldForContent(fieldObj, fieldVal, errors) {
            var re = /^[0123456789]+$/;
            if (!re.exec(fieldVal)) {
                errors.push(newErrObj(fieldObj, 'BCD fields should contain decimal characters only.'));
                return true;
            }
            return false;

        }

        function validateBcdBinaryFieldForLength(fieldObj, fieldVal, errors) {
            if (fieldVal.length % 2 != 0) {
                errors.push(newErrObj(fieldObj, 'BCD/BINARY fields required to have even number of characters - field has only ' + fieldVal.length));
                return true;
            }
            return false;

        }

        function validateFields() {

            var errors = new Array();
            for (var i = 0, j = 0; i < currentMsgFields.length; i++) {
                var fieldObj = currentMsgFields[i];
                validateField(fieldObj, errors);

            }

            var errMsg = 'Please fix the following errors -\n<ol>';
            for (var i = 0; i < errors.length; i++) {
                var errObj = errors[i];
                var elem = document.getElementById(reqFieldsPrefixId2 + errObj.Id);
                elem.style.color = 'red';


                var errorTextElem = document.getElementById(reqFieldsValErrorIdPrefix + errObj.Id);
                errorTextElem.innerHTML = errObj.ErrorText;
                errorTextElem.style.display = "block";
                errMsg += '<li>' + 'Field: [' + errObj.FieldName + '] Error:  ' + errObj.ErrorText + '</li>\n';

            }
            errMsg += '</ol>';
            if (errors.length > 0) {
                showErrorMessage(errMsg);
            }


            return errors;

        }


        /**
        This function will send a msg to the 'Host:Ip'
        */
        function jsSendMsg() {

            document.getElementById('idJsResponseTable').innerHTML = "";

            var validationErrors = validateFields();
            if (validationErrors.length > 0) {
                console.log('unable to send msg because of validation errors');
                return;
            }

            var hostElem = document.getElementById('idJsHost');
            var portElem = document.getElementById('idJsPort');

            if (!hostElem.value) {
                showErrorMessage('please provide a valid host name/ip address');
                return;

            }
            var re = /^[0-9]+$/;
            if (!re.exec(portElem.value)) {
                showErrorMessage('please provide a valid port number');
                return;

            }

            var host = hostElem.value;
            var port = portElem.value;




            var selectedObjs = document.getElementsByClassName('cl_req_field_sel_cb');
            var resultObj = new Array();
            for (var i = 0, j = 0; i < selectedObjs.length; i++) {

                var childNode = selectedObjs[i];
                //alert(JSON.stringify(childNode));
                if (childNode.id) {
                    //alert(childNode.id)

                    if (childNode.checked) {
                        var index = childNode.id.indexOf('_');
                        var childNodeId = childNode.id.substring(index + 1, childNode.id.length);

                        var fieldValue = document.getElementById(reqFieldsPrefixId2 + childNodeId).value;
                        var obj = new Object();
                        obj.Id = parseInt(childNodeId);
                        obj.Value = fieldValue;
                        resultObj[j++] = obj;
                    }

                }


            }
            var msg = JSON.stringify(resultObj);
            var specsElem = document.getElementById('idJsSpec');
            var selectedOption = specsElem.options[specsElem.selectedIndex];
            var specId = selectedOption.id;
            selectedOption = document.getElementById('idJsSpecMsgs');
            var msgId = selectedOption.options[selectedOption.selectedIndex].id;

            console.log('sending message - ' + msg);

            console.log('spec id = ' + specId + 'msg id = ' + msgId);
            var postData = 'host=' +
                host + '&' + 'port=' + port + '&' + 'specId=' + specId + "&" + 'msgId=' + msgId + "&" + "msg=" + msg;
            //var postData = 'specId=' + specId + "&" + 'msgId=' + msgId + "&" + "msg=" + msg;

            console.log('postData = ' + postData);
            doAjaxCall('/iso/v0/send', function(responseText) {
                //alert(responseText);
                var responseData = JSON.parse(responseText);

                var htmlContent = '';
                htmlContent += '<tr><td colspan=\"4\" align="center"><div class="cl_segment_header_resp">Message Response</div></td><tr>';
                htmlContent += "<tr class=\"cl_small_text\"><th > Selected? </th> <th> Field </th> <th> Value </th></tr>\n";
                for (var i = 0; i < currentMsgFields.length; i++) {
                    var fieldObj = currentMsgFields[i];
                    htmlContent += getFieldHtml(fieldObj, fieldValue = "", isRequest = false);
                    htmlContent += appendChildFields(fieldObj, isRequest = false);
                }

                //alert(htmlContent);

                var elem = document.getElementById('idJsResponseTable');
                elem.innerHTML = htmlContent;

                for (var i = 0; i < responseData.length; i++) {

                    console.log('setting ' + responseData[i].Id + ' ' + responseData[i].Value);

                    var id = respFieldsPrefixId0 + responseData[i].Id;
                    var fieldId = respFieldsPrefixId2 + responseData[i].Id;
                    document.getElementById(id).checked = true;
                    document.getElementById(fieldId).value = responseData[i].Value;
                }

                var elems = document.getElementsByClassName('cl_vsmall_btn_view');
                for (var i = 0; i < elems.length; i++) {
                    elems[i].addEventListener('click', function(event) {

                        var fieldVal = "";
                        var index = event.target.id.indexOf('_');
                        var fieldId = event.target.id.substring(index + 1, event.target.id.length);
                        console.log('fieldid =' + fieldId);
                        fieldVal = getResponseFieldValElem(fieldId).value;


                        jsShowUserInputDialog(event, fieldId, fieldVal, false, true);
                    }, true);
                }


            }, postData, 'POST', encoding = 'application/x-www-form-urlencoded');




        }

        function showErrorMessage(errMsg) {

            enableOverlay();
            document.getElementById('idJsErrorMsg').innerHTML = errMsg;

            var elem = document.getElementById('idJsErrorDiv');
            elem.style.display = "block";
            elem.style.position = "fixed";
            elem.style.left = "35%";
            elem.style.top = "50%";
            //elem.style['z-index'] = "2";

        }

        function closeErrorDialog() {
            document.getElementById('idJsErrorDiv').style.display = "none";
            disableOverlay();
        }

        function showAboutDialog() {
            document.getElementById('idAboutIsoWebSim').style.display = "block";
        }


        function closeAboutDialog() {
            document.getElementById('idAboutIsoWebSim').style.display = "none";
        }

    </script>

</head>

<body onload="init()">

    <div id="overlay"></div>

    <div id="headerDiv">
        <div class="cl_cursive_heading"> ISO WebSim </div>
        <div class="cl_small_text_new">Developer(s): Raghavendra Balgi (rkbalgi@gmail.com) </div>
    </div>



    <div id="navDiv" style="content-align:left;">


        <ul style="list-style-type: none; margin:0;padding:0;">
            <li>
                <input class="cl_small_btn" type="button" value="Load Template" onClick="jsLoadTemplate()" />
            </li>
            <li>
                <input class="cl_small_btn" type="button" value="Parse Trace" onClick="jsShowTraceDialog()" />
            </li>
            <li>
                <input class="cl_small_btn" type="button" value="Validate" onClick="validateFields()" />
            </li>
            <li>
                <input class="cl_small_btn" type="button" value="Send To Host" onClick="jsSendMsg()" />
            </li>
            <li>
                <input class="cl_small_btn" type="button" value="About" onClick="showAboutDialog()" />
            </li>
        </ul>

    </div>



    <div id="bodyDiv">

        <table style="position: relative;">
            <tr>
                <td align="center">
                    <div class="cl_text_label">Specs</div>
                    <!--<input class="cl_small_btn" type="button" value="Load Specs" onClick="jsLoadSpecs()" /> -->
                </td>

                <td>
                    <select onchange="jsLoadSpecMessages(true)" id="idJsSpec" name="jsSpec" class="cl_std_cbox" style="width: 200px;">
                    </select>
                </td>

            </tr>


            <! -- second row -->

            <tr>
                <td align="center">
                    <!--<input class="cl_small_btn" type="button" value="Load Messages" onClick="jsLoadSpecMessages()" />-->
                    <div class="cl_text_label">Spec Messages</div>
                </td>

                <td>
                    <select onchange="jsLoadTemplate()" id="idJsSpecMsgs" class="cl_std_cbox" name="jsSpecMsgs" style="width: 200px;"></select>
                </td>

            </tr>

            <tr>
                <table>

                    <tr>

                        <td align="center">
                            <div class="cl_text_label">Host</div>
                        </td>
                        <td align="center">
                            <input class="cl_std_text_box" id="idJsHost" type="text" value="127.0.0.1" />
                        </td>
                        <td align="center">
                            <div class="cl_text_label">Port</div>
                        </td>
                        <td>
                            <input class="cl_std_text_box" id="idJsPort" type="text" value="7777" />
                        </td>

                    </tr>
                    <tr>

                        <td align="center">
                            <div class="cl_text_label">MLI</div>
                        </td>
                        <td>
                            <select class="cl_std_cbox" style="width: 50px;" id="idJsMli">
                                <option class="cl_cb_opt" name="2I">2I</option>
                                <option class="cl_cb_opt" name="2E">2E</option>
                            </select>
                        </td>


                        <td></td>
                    </tr>


                </table>
            </tr>
        </table>

        <br/>
        <br/>
        <table>
            <tr>
                <td>
                    <!-- Request Table -->
                    <table id="idJsRequestTable">

                    </table>
                </td>

                <td style="width: 80px;"></td>


                <td>
                    <!-- Response Table -->
                    <table id="idJsResponseTable">

                    </table>
                </td>
            </tr>
        </table>
    </div>

    <div id="idJsTraceDiv" class="cl_trace_dlg">

        <div class="cl_dlg_header">Hex Trace Input Dialog</div>
        <textarea class="cl_trace_value" id="idJsTrace" rows="5" cols="40" style=" resize: none; margin: 10px; margin:5px; width: 440px; height:140px;">F1F1F0F0723C240128428000F1F5F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9F0F0F4F0F0F0F0F0F0F0F0F0F0F0F1F0F0F0F0F4F2F1F1F0F2F4F5F1F1F1F0F6F0F2F0F5F1F0F1F8F1F9F4F3F1F2F0F5F0F3F0F9F0F1F8F4F0F2F6F1F1F0F1F1F0F1F1F4F0F0F1F0F3F7F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9C4F0F8F0F8F1F0F1F0F4F0F1F3F6F6F7F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F1F5F4F3F4F5F0F1F3F6F74040404040F2F4F9C1E7C9C1C3F2F1F0F9F0F1F0F1C1D7D5F2F3C6D9D6E2E340D1C1D5C540D440D4D9E240404040404040C1C2C34040E7E8E94040D9E3C7F6F1F1F0C1C2C3404061C4C5C6404061C7C8C9404061D1D2D3404061D4D5D6404061D7D8D9404061E2E3E4404061E5E6E7404061E8E9C1404061E7E8E94040C1D3C3F5F5F0F9C1C240404061E7E840404061C2C340404061C3C440404061C4C540404061C4C54040406140C3C440404061C2C340404061C1C2404040C1C2C3F1F2F3C4C5C6F4F5F6C7C8C9F7F8F9D1D2D3F0F1F2F0F0F1F1F2F74BF1F4F24BF1F5F14BF2F2F3C3C540F2F4C3C6C6D9D6E2E37CC5D4C1C9D3C1C4C4D9C5E2E24BC3D6D4F8F4F0</textarea>


        <br/>
        <br/>
        <div align="center" style="align-content:center;">
            <input type="button" class="cl_small_btn" value="OK " onclick="jsParseTrace()" />
            <input type="button" class="cl_small_btn" value="Cancel " onclick="jsCancelTraceParseAction()" />
        </div>
    </div>

    <div id="idJsErrorDiv" class="cl_trace_dlg">

        <div class="cl_dlg_header"> WebSim Error Message</div>
        <div id="idJsErrorMsg" class="cl_small_text " style="overflow:auto; margin: 5px; margin:5px; width: 440px; height:140px; color: red;"></div>

        <br/>
        <br/>
        <div align="center" style="align-content:center; ">
            <input type="button" class="cl_small_btn" value="OK" onclick="closeErrorDialog()" />

        </div>
    </div>

    <div id="idJsUserInputDiv" class="cl_trace_dlg">

        <div class="cl_dlg_header"> User Input Dialog</div>
        <textarea class="cl_trace_value" id="idJsUserInput" rows="5" cols="40" style=" resize: none; margin: 10px; margin:5px; width: 440px; height:140px;"></textarea>


        <br/>
        <br/>
        <div align="center" style="align-content:center;">
            <input type="button" class="cl_small_btn" value="OK " onclick="jsProcessUserInput()" />
            <input type="button" class="cl_small_btn" value="Cancel " onclick="jsCancelUserInputDialog()" />
        </div>
    </div>
    <div id="idAboutIsoWebSim" class="cl_about_dlg">

        <div class="cl_dlg_header"> About ISO WebSim </div>
        <div class="cl_small_text" style=" resize: none; margin: 10px; margin:5px; width: 440px; height:200px;">
            <p>
                Iso Websim is a ISO8583 simulator built using golang (http://golang.org). It provides a simple interface to load ISO specifications. The specifications themselves are defined in text file (more information on developing your own specs can be found here - <a href="https://github.com/rkbalgi/isosim/blob/master/specs/isoSpecs.spec">https://github.com/rkbalgi/isosim/blob/master/specs/isoSpecs.spec</a>. The page you are viewing is hosted by a golang program that is supplied the spec definitions file to use. You can load an existing trace or create a message from scratch and send it to a ISO host (identified by host and a port). Note: Please note that this application has been tested to work only on chrome browser.
            </p>
        </div>


        <br/>
        <br/>
        <div align="center" style="align-content:center;">
            <input type="button" class="cl_small_btn" value="OK" onclick="closeAboutDialog()" />
        </div>
    </div>


</body>

</html>
