package tests

import (
	"testing"
	"encoding/hex"
	"github.com/rkbalgi/isosim/lite/spec"
)

func Test_ParseMsg(t *testing.T) {

	spec.PrintAllSpecsInfo();
	msgData, _ := hex.DecodeString("F1F1F0F0723C240128428000F1F5F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9F0F0F4F0F0F0F0F0F0F0F0F0F0F0F1F0F0F0F0F4F2F1F1F0F2F4F5F1F1F1F0F6F0F2F0F5F1F0F1F8F1F9F4F3F1F2F0F5F0F3F0F9F0F1F8F4F0F2F6F1F1F0F1F1F0F1F1F4F0F0F1F0F3F7F3F7F5F7F2F2F6F5F8F7F0F9F2F3F9C4F0F8F0F8F1F0F1F0F4F0F1F3F6F6F7F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F1F5F4F3F4F5F0F1F3F6F74040404040F2F4F9C1E7C9C1C3F2F1F0F9F0F1F0F1C1D7D5F2F3C6D9D6E2E340D1C1D5C540D440D4D9E240404040404040C1C2C34040E7E8E94040D9E3C7F6F1F1F0C1C2C3404061C4C5C6404061C7C8C9404061D1D2D3404061D4D5D6404061D7D8D9404061E2E3E4404061E5E6E7404061E8E9C1404061E7E8E94040C1D3C3F5F5F0F9C1C240404061E7E840404061C2C340404061C3C440404061C4C540404061C4C54040406140C3C440404061C2C340404061C1C2404040C1C2C3F1F2F3C4C5C6F4F5F6C7C8C9F7F8F9D1D2D3F0F1F2F0F0F1F1F2F74BF1F4F24BF1F5F14BF2F2F3C3C540F2F4C3C6C6D9D6E2E37CC5D4C1C9D3C1C4C4D9C5E2E24BC3D6D4F8F4F0");
	t.Log("Parsing ISO message ");
	for _, isoSpec := range (spec.GetSpecs()) {

		if (isoSpec.Name == "GCAG") {
			defaultMsg := isoSpec.GetMessages()[0]
			parsedMsg, err := defaultMsg.Parse(msgData);
			if (err != nil) {
				t.Fatal("Test Failed. Error = " + err.Error())

			}

			//lets copy this into a response
			responseMsg := parsedMsg.Copy();

			Iso := spec.NewIso(responseMsg);
			msgType := Iso.Get("Message Type");
			isoBitmap := Iso.Bitmap();
			if msgType.Value() == "1100" && isoBitmap.IsOn(4) {
				msgType.Set("1110");
				isoBitmap.Set(38, "ABC123");
				isoBitmap.Set(39, "000");
			}

			responseMsg.Assemble();

		}
	}

}
